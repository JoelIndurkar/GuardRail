services:
  n8n:
    image: n8nio/n8n
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=changeme
    entrypoint: >
      sh -c "
      if [ ! -f /home/node/bin/trivy ]; then
        wget -qO- https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /home/node/bin;
      fi
      && n8n start"

  scanner:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./scanner:/app
      - guardrail_data:/data
    environment:
      - SCAN_API_KEY=${SCAN_API_KEY}
    command: sh -c "apk add --no-cache git wget curl python3 make g++ && wget -qO- https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin && mkdir -p /data && npm install && node index.js"
    ports:
      - "3001:3001"

  dashboard-api:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./dashboard-api:/app
      - guardrail_data:/data
    command: sh -c "npm install && node index.js"
    ports:
      - "3002:3002"

volumes:
  n8n_data:
  guardrail_data:
